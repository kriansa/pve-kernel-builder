#!/usr/bin/env bash
#
# Runs the kernel build using a Docker container
# To kill it, you need to run: $ docker kill kernel-builder
#
# Usage: bin/build [OPTIONS]
#
# Options:
#   --shell: Get a bash interactive shell instead of the standard compilation

cd "$(dirname "$0")/.." || exit

# shellcheck disable=SC1091
set -a && source ".env" && set +a

if [ "$1" == "--shell" ]; then
  extra_args=-it
  run_cmd="/bin/bash"
else
  run_cmd="kernel-build"
fi

docker run --rm --name "kernel-builder" \
  -v "$(pwd)/patches:/patches" \
  -v "$(pwd)/src:/src" \
  -v "$HOME/.aws/credentials:/root/.aws/credentials" \
  -e "AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION" \
  -e "AWS_PROFILE=$AWS_PROFILE" \
  -e "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" \
  -e "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" \
  -e "ARTIFACTS_S3_BUCKET=$ARTIFACTS_S3_BUCKET" \
  -e "REPO_S3_BUCKET=$REPO_S3_BUCKET" \
  $extra_args \
  kriansa/pve-kernel-builder:current "$run_cmd"
